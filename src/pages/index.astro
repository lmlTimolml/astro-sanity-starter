---
/* import cleanClass from '../utils/cleanClass' */
import deepClean from '../utils/deepClean';
import { loadQuery } from '../sanity/lib/load-query';
import { footerFragment, modulesFragment, navfragment, pageMeta, seoSettings } from '../sanity/lib/queries/fragments';
import Layout from '../layouts/Layout.astro';
import type { PageType } from '../types/sanityTypes';

import { components } from '../sanity/lib/components';
import Footer from '../components/Footer.astro';
import Nav from '../components/Nav.astro';

const { data: homepage } = await deepClean(loadQuery<PageType>)({
  query: `*[_type == "homepage"][0]{
    title,
    pageColor,
    ${pageMeta},
    ${seoSettings},
    ${navfragment},
    ${footerFragment},
    ${modulesFragment}
  }`
});

const modules = homepage?.modules ?? [];
const pageColor = homepage?.pageColor;
const footer = homepage?.footer;
const nav = homepage?.navigation;
/* const customClass = [cleanClass(pageColor)].join(' '); */

export const prerender = false;

const page = homepage;
const settings = page.seoSettings;

---

<Layout page={page} settings={settings}>
  { nav ? (<Nav {...nav} />) : null }
  <main class={`grid-component-wrapper mt-28 ${pageColor}`}>

  {modules?.map((mod, index) => {
  const Component = components[mod._type];
  if (!Component) {
    console.warn(`⚠️ No component found for module type: ${mod._type}`);
    return null;
  }
  return <Component {...mod} key={index} />;
})}

</main>
{ footer ? (<Footer {...footer} />) : null }
</Layout>